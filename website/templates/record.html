{% extends "user-base.html" %}

{% block title %}Record Speech Audio Page{% endblock %} 

{% block content %}
<main id="main">
    <!-- ======= Breadcrumbs Section ======= -->
    <section class="breadcrumbs">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Record Speech Audio</h2>
                <ol>
                    <li><a href="/">Home</a></li>
                    <li>Record Speech Audio</li>
                </ol>
            </div>
        </div>
    </section><!-- End Breadcrumbs Section -->

    <!-- ======= Record Section ======= -->
    <section class="record" data-aos="fade-up" data-aos-easing="ease-in-out" data-aos-duration="500">
        <div class="container">
            <div class="row">
                <div style="padding:30px;" class="col-lg-8 mx-auto col-gui rounded">
                    <h1 style="text-align: center;">Record Your Audio</h1>
                    <br>
                    <h4>1. Record speech audio</h4>
                    <button onclick="startRecording()" class="btn btn-success">Record Audio</button>
                    <button onclick="stopRecording()" class="btn btn-secondary" disabled>Stop Recording</button><br>
                    <br>
                    <h4>2. Audio preview</h4>
                    <audio id="audioPlayback" controls hidden></audio>
                    <br><br>
                    <h4>3. Predict speech audio emotion</h4>
                    <button onclick="predictRecordedEmotion()" class="btn btn-success">Predict Recorded Audio</button>
                    <div id="emotionBlock" class="mt-3 rounded" style="text-align: center; max-height: 200px; overflow-y: auto; border: 1px solid #000000; padding: 10px;">
                        <h4 id="resultMessage" class="mt-1"></h4> <!-- Paragraph for displaying the result -->
                    </div>
                </div>
            </div>
        </div>
    </section><!-- End Record Section -->
</main><!-- End #main -->

<script>
  let mediaRecorder;
  let audioChunks = [];

  function startRecording() {
      navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
              const mimeType = 'audio/wav';
              const options = MediaRecorder.isTypeSupported(mimeType) ? { mimeType } : {};

              mediaRecorder = new MediaRecorder(stream, options);
              mediaRecorder.start();
              audioChunks = [];
              document.querySelector('button[onclick="startRecording()"]').disabled = true;
              document.querySelector('button[onclick="stopRecording()"]').disabled = false;

              mediaRecorder.addEventListener("dataavailable", event => {
                  audioChunks.push(event.data);
              });

              // Moved inside the then block
              mediaRecorder.addEventListener("stop", () => {
                  const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                  const audioUrl = URL.createObjectURL(audioBlob);
                  const audio = document.getElementById('audioPlayback');
                  audio.src = audioUrl;
                  audio.hidden = false;
                  document.getElementById('predictRecordedEmotion').hidden = false;
                  alert("Audio Recorded!"); // Popup alert
              });
          });
  }

  function stopRecording() {
      mediaRecorder.stop();
      document.querySelector('button[onclick="startRecording()"]').disabled = false;
      document.querySelector('button[onclick="stopRecording()"]').disabled = true;
  }

  function predictRecordedEmotion() {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const formData = new FormData();
    formData.append('audio_data', audioBlob, 'recording.wav');

    fetch('/predict_recorded_emotion', {
        method: 'POST',
        body: formData
    }).then(response => response.json())
      .then(data => {
          const emotion = data.emotion.toLowerCase();
          const emotionBlock = document.getElementById('emotionBlock');
          const resultMessage = document.getElementById('resultMessage');
          resultMessage.innerText = 'Emotion: ' + data.emotion + ' (Confidence: ' + data.confidence + ')';

          // Remove existing emotion classes
          emotionBlock.classList.remove('emotion-neutral', 'emotion-happy', 'emotion-sad', 'emotion-angry');

          // Add new emotion class to the block
          switch (emotion) {
              case 'happy':
                  emotionBlock.classList.add('emotion-happy');
                  break;
              case 'sad':
                  emotionBlock.classList.add('emotion-sad');
                  break;
              case 'angry':
                  emotionBlock.classList.add('emotion-angry');
                  break;
              default:
                  emotionBlock.classList.add('emotion-neutral');
          }
      }).catch(error => {
          console.error('Error:', error);
      });
    }
</script>
{% endblock %}
